<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <script src="assets/tailwind.min.js"></script>
  <script src="assets/lucide.min.js"></script>
  <style>
    body {
      color: white;
      overflow: hidden;
    }

    .post-item {
      padding: 12px 14px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .post-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(4px);
    }

    .watched-card {
      background: rgba(168, 85, 247, 0.08);
      border: 1px solid rgba(168, 85, 247, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .watched-card:hover {
      background: rgba(168, 85, 247, 0.12);
      border-color: rgba(168, 85, 247, 0.5);
    }

    .drag-handle {
      padding: 18px 20px;
      cursor: move;
      -webkit-app-region: drag;
      background: linear-gradient(to bottom, rgba(168, 85, 247, 0.15), transparent);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .no-drag {
      -webkit-app-region: no-drag;
    }

    /* 로딩 오버레이 */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 18, 30, 0.7);
      backdrop-filter: blur(4px);
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(168, 85, 247, 0.2);
      border-top-color: #a855f7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="panel-glass p-0 h-screen flex flex-col relative">
  <!-- Loading Overlay -->
  <div id="gallery-loading" class="loading-overlay">
    <div class="spinner"></div>
    <span class="text-[10px] font-black text-purple-400 uppercase tracking-widest">Refreshing...</span>
  </div>

  <!-- Header -->
  <div class="drag-handle flex justify-between items-center shadow-lg">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center border border-purple-500/30">
        <i data-lucide="bell" class="w-5 h-5 text-purple-400"></i>
      </div>
      <div class="flex flex-col">
        <div class="flex items-center gap-2">
          <span class="text-xs font-black text-white tracking-tight">갤러리 모니터</span>
          <span id="keyword-badge"
            class="text-[9px] bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded-full font-black border border-purple-500/30">전체
            알림</span>
        </div>
        <span id="conn-status" class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Connected</span>
      </div>
    </div>
    <div class="flex items-center gap-1.5 no-drag">
      <button id="notify-toggle" onclick="toggleNotify()"
        class="w-8 h-8 flex items-center justify-center hover:bg-white/5 rounded-lg transition-colors" title="알림 설정">
        <i id="notify-toggle-icon" data-lucide="bell" class="w-4 h-4"></i>
      </button>
      <button onclick="refreshGallery()"
        class="w-8 h-8 flex items-center justify-center hover:bg-white/5 rounded-lg transition-colors" title="새로고침">
        <i data-lucide="refresh-cw" class="w-4 h-4 text-slate-400"></i>
      </button>
      <button onclick="window.close()"
        class="w-8 h-8 flex items-center justify-center hover:bg-red-500/10 hover:text-red-400 rounded-lg transition-colors">
        <i data-lucide="x" class="w-4 h-4 text-slate-400"></i>
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-hidden flex flex-col p-4 space-y-4 no-drag">
    <!-- 키워드 가이드 배너 (항상 노출) -->
    <div id="keyword-guide"
      class="shrink-0 p-3 bg-purple-500/10 border border-purple-500/20 rounded-xl flex items-center justify-between transition-all">
      <div id="guide-text-container" class="flex items-center gap-2 text-purple-400">
        <i id="guide-icon" data-lucide="info" class="w-4 h-4 shrink-0"></i>
        <div class="flex flex-col">
          <span id="guide-title" class="text-[10px] font-black tracking-tight">모든 새 글 알림을 수신 중입니다</span>
          <span id="guide-subtext"
            class="text-[9px] font-medium empty:hidden mt-0.5 opacity-80 break-words line-clamp-2"></span>
        </div>
      </div>
      <button id="guide-btn" onclick="window.electronAPI.toggleSettings('gallery')"
        class="shrink-0 ml-2 text-[9px] bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 px-3 py-1.5 rounded-lg font-bold transition-colors">설정
        열기</button>
    </div>

    <div
      class="flex gap-2 bg-black/40 p-1.5 rounded-xl border border-white/5 focus-within:border-purple-500/50 transition-colors shrink-0">
      <input id="watch-input"
        class="bg-transparent flex-1 px-3 py-1.5 text-xs text-slate-200 outline-none placeholder:text-slate-700"
        placeholder="글 번호 또는 URL 입력..." onkeypress="if(event.key==='Enter')addWatch()">
      <button onclick="addWatch()"
        class="text-[10px] bg-purple-600 hover:bg-purple-500 text-white px-4 py-1.5 rounded-lg font-black transition-all active:scale-90 shadow-lg">추가</button>
    </div>

    <div class="flex-1 custom-scroll overflow-y-auto space-y-6 pr-1">
      <div>
        <div class="flex justify-between items-center px-1 mb-3">
          <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><i
              data-lucide="eye" class="w-3 h-3"></i> 감시 중인 게시글</h3>
          <span id="watch-count"
            class="text-[9px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full font-black border border-purple-500/20">0</span>
        </div>
        <div id="watch-list" class="space-y-2"></div>
      </div>
      <div>
        <div class="px-1 mb-3">
          <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><i
              data-lucide="list" class="w-3 h-3"></i> 최신 갤러리 게시글</h3>
        </div>
        <div id="post-list" class="space-y-1"></div>
      </div>
    </div>
  </div>

  <script>
    function refreshIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }
    async function refreshGallery() {
      const loader = document.getElementById('gallery-loading');
      loader.classList.add('active');
      try {
        const watched = await window.electronAPI.galleryForceCheck();
        renderWatchList(watched);
      } catch (e) {
        console.error(e);
      } finally {
        setTimeout(() => loader.classList.remove('active'), 300); // 부드러운 전환을 위해 약간의 지연
      }
    }
    function renderWatchList(watched) {
      const list = document.getElementById('watch-list');
      const countLabel = document.getElementById('watch-count');
      list.innerHTML = '';
      const entries = Object.entries(watched || {});
      countLabel.innerText = entries.length;
      if (entries.length === 0) { list.innerHTML = '<div class="text-[10px] text-slate-700 text-center py-6 bg-white/2 border border-dashed border-white/5 rounded-2xl italic font-medium">감시 중인 글이 없습니다.</div>'; return; }
      entries.forEach(([no, info]) => {
        const div = document.createElement('div');
        div.className = 'post-item watched-card group';
        div.innerHTML = `<div class="flex flex-col flex-1 truncate"><span class="text-[9px] text-purple-400 font-black mb-0.5 tracking-tighter">#${no}</span><span class="truncate text-[11px] text-slate-100 font-black">${info.title}</span></div><div class="flex items-center gap-3"><div class="flex items-center gap-1.5 px-2 py-1 bg-purple-500/10 rounded-lg"><i data-lucide="message-square" class="w-3 h-3 text-purple-400"></i><span class="text-[10px] font-black text-purple-300">${info.commentCount >= 0 ? info.commentCount : '?'}</span></div><button onclick="event.stopPropagation(); removeWatch(${no})" class="text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>`;
        div.onclick = () => window.electronAPI.galleryOpenPost(no);
        list.appendChild(div);
      });
      refreshIcons();
    }
    async function addWatch() {
      const input = document.getElementById('watch-input');
      const btn = document.querySelector('button[onclick="addWatch()"]');
      const val = input.value.trim();
      const match = val.match(/\d+/);
      if (!match) return;
      const postNo = parseInt(match[0]);
      input.disabled = true;
      const originalBtnHTML = btn.innerHTML;
      btn.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>';
      btn.disabled = true;
      refreshIcons();
      try {
        const success = await window.electronAPI.galleryAddWatch(postNo);
        if (success) { input.value = ''; const watched = await window.electronAPI.galleryGetWatched(); renderWatchList(watched); }
        else alert('존재하지 않는 게시글이거나 정보를 불러올 수 없습니다.');
      } catch (e) { console.error(e); }
      finally { input.disabled = false; btn.innerHTML = originalBtnHTML; btn.disabled = false; input.focus(); refreshIcons(); }
    }
    async function removeWatch(no) { window.electronAPI.galleryRemoveWatch(no); const watched = await window.electronAPI.galleryGetWatched(); renderWatchList(watched); }
    window.electronAPI.onGalleryPosts((posts) => {
      const list = document.getElementById('post-list');
      list.innerHTML = '';
      if (!posts || posts.length === 0) { list.innerHTML = '<div class="text-[10px] text-slate-700 text-center py-10 font-bold uppercase tracking-widest opacity-50">게시글이 없습니다.</div>'; return; }
      posts.slice(0, 20).forEach(p => {
        const div = document.createElement('div');
        div.className = 'post-item group';
        div.innerHTML = `<div class="w-10 text-[9px] text-slate-600 font-black tracking-tighter">#${p.no}</div><div class="flex-1 truncate text-xs text-slate-400 group-hover:text-white transition-colors font-medium">${p.title}</div>${p.replyCount > 0 ? `<div class="text-[10px] text-purple-500/60 font-black px-1.5 py-0.5 bg-purple-500/5 rounded border border-purple-500/10 group-hover:bg-purple-500/20 group-hover:text-purple-400 group-hover:border-purple-500/30 transition-all">[${p.replyCount}]</div>` : ''}`;
        div.onclick = () => window.electronAPI.galleryOpenPost(p.no);
        list.appendChild(div);
      });
      refreshIcons();
    });
    window.electronAPI.onGalleryWatchedUpdate((watched) => renderWatchList(watched));
    window.electronAPI.onConfigData((config) => {
      const badge = document.getElementById('keyword-badge');
      const guide = document.getElementById('keyword-guide');
      const guideTextContainer = document.getElementById('guide-text-container');
      const guideIcon = document.getElementById('guide-icon');
      const guideTitle = document.getElementById('guide-title');
      const guideSubtext = document.getElementById('guide-subtext');
      const guideBtn = document.getElementById('guide-btn');

      if (!badge) return;

      const kwCount = config.galleryKeywords?.length || 0;
      if (kwCount > 0) {
        badge.innerText = `키워드 ${kwCount}`;
        badge.className = 'text-[9px] bg-purple-600 text-white px-1.5 py-0.5 rounded-full font-black border border-purple-400 shadow-[0_0_8px_rgba(168,85,247,0.4)]';
        if (guide) {
          guide.className = 'shrink-0 p-3 bg-purple-500/10 border border-purple-500/20 rounded-xl flex items-center justify-between transition-all';
          guideTextContainer.className = 'flex items-center gap-2 text-purple-400';
          guideIcon.setAttribute('data-lucide', 'info');
          guideTitle.innerText = `${kwCount}개의 키워드를 감시 중입니다`;
          guideSubtext.innerText = config.galleryKeywords.join(', ');
          guideBtn.className = 'shrink-0 ml-2 text-[9px] bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 px-3 py-1.5 rounded-lg font-bold transition-colors';
          guideBtn.innerText = '설정 변경';
        }
      } else {
        badge.innerText = '전체 알림';
        badge.className = 'text-[9px] bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded-full font-black border border-purple-500/30';
        if (guide) {
          guide.className = 'shrink-0 p-3 bg-purple-500/10 border border-purple-500/20 rounded-xl flex items-center justify-between transition-all';
          guideTextContainer.className = 'flex items-center gap-2 text-purple-400';
          guideIcon.setAttribute('data-lucide', 'info');
          guideTitle.innerText = '모든 새 글 알림을 수신 중입니다';
          guideSubtext.innerText = '키워드를 설정하면 원하는 글만 필터링하여 수신할 수 있습니다';
          guideBtn.className = 'shrink-0 ml-2 text-[9px] bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 px-3 py-1.5 rounded-lg font-bold transition-colors';
          guideBtn.innerText = '키워드 추가';
        }
      }
      refreshIcons();
    });
    window.electronAPI.onGalleryConnectionStatus((isConnected) => {
      const statusLabel = document.getElementById('conn-status');
      if (isConnected) { statusLabel.innerText = 'Connected'; statusLabel.className = 'text-[9px] text-slate-500 font-bold uppercase tracking-wider'; }
      else { statusLabel.innerText = 'Disconnected'; statusLabel.className = 'text-[9px] text-red-500 font-black uppercase tracking-wider animate-pulse'; }
    });
    window.onload = async () => { refreshGallery(); const enabled = await window.electronAPI.galleryGetNotify(); updateNotifyIcon(enabled); };
    function updateNotifyIcon(enabled) {
      const icon = document.getElementById('notify-toggle-icon');
      if (enabled) { icon.setAttribute('data-lucide', 'bell'); icon.className = 'w-4 h-4 text-purple-400'; }
      else { icon.setAttribute('data-lucide', 'bell-off'); icon.className = 'w-4 h-4 text-slate-600'; }
      refreshIcons();
    }
    async function toggleNotify() { const current = await window.electronAPI.galleryGetNotify(); const newState = !current; window.electronAPI.gallerySetNotify(newState); updateNotifyIcon(newState); }
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') window.close(); });
    refreshIcons();
  </script>
</body>

</html>