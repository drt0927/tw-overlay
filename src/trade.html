<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <script src="assets/tailwind.min.js"></script>
    <script src="assets/lucide.min.js"></script>
    <style>
        body {
            color: white;
            overflow: hidden;
        }

        .post-item {
            padding: 12px 14px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .post-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .drag-handle {
            padding: 18px 20px;
            cursor: move;
            -webkit-app-region: drag;
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.15), transparent);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .no-drag {
            -webkit-app-region: no-drag;
        }

        /* 로딩 오버레이 */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 18, 30, 0.7);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="panel-glass p-0 h-screen flex flex-col relative">
    <!-- Loading Overlay -->
    <div id="trade-loading" class="loading-overlay">
        <div class="spinner"></div>
        <span class="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Refreshing...</span>
    </div>

    <!-- Header -->
    <div class="drag-handle flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center border border-emerald-500/30">
                <i data-lucide="store" class="w-5 h-5 text-emerald-400"></i>
            </div>
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-black text-white tracking-tight">거래 게시판 모니터</span>
                    <span id="keyword-badge"
                        class="text-[9px] bg-emerald-500/20 text-emerald-400 px-1.5 py-0.5 rounded-full font-black border border-emerald-500/30">키워드
                        부족</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="server-badge" class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">서버
                        확인중</span>
                    <span id="conn-status"
                        class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Connected</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-1.5 no-drag">
            <button onclick="refreshTrade()"
                class="w-8 h-8 flex items-center justify-center hover:bg-white/5 rounded-lg transition-colors"
                title="새로고침">
                <i data-lucide="refresh-cw" class="w-4 h-4 text-slate-400"></i>
            </button>
            <button onclick="window.close()"
                class="w-8 h-8 flex items-center justify-center hover:bg-red-500/10 hover:text-red-400 rounded-lg transition-colors">
                <i data-lucide="x" class="w-4 h-4 text-slate-400"></i>
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col p-4 space-y-4 no-drag">
        <!-- 키워드 가이드 배너 (항상 노출) -->
        <div id="keyword-guide"
            class="shrink-0 p-3 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center justify-between transition-all">
            <div id="guide-text-container" class="flex items-center gap-2 text-red-400">
                <i id="guide-icon" data-lucide="alert-circle" class="w-4 h-4 shrink-0"></i>
                <div class="flex flex-col">
                    <span id="guide-title" class="text-[10px] font-black tracking-tight">키워드를 등록해야 모니터링이 시작됩니다</span>
                    <span id="guide-subtext"
                        class="text-[9px] font-medium empty:hidden mt-0.5 opacity-80 break-words line-clamp-2"></span>
                </div>
            </div>
            <button id="guide-btn" onclick="window.electronAPI.toggleSettings('trade')"
                class="shrink-0 ml-2 text-[9px] bg-red-500/20 hover:bg-red-500/30 text-red-300 px-3 py-1.5 rounded-lg font-bold transition-colors">설정
                열기</button>
        </div>

        <div class="flex-1 custom-scroll overflow-y-auto space-y-6 pr-1">
            <div>
                <div class="px-1 mb-3">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="list" class="w-3 h-3"></i> 최근 매칭된 게시글
                    </h3>
                </div>
                <div id="post-list" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
        function refreshIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }

        let isForcingCheck = false;

        async function refreshTrade() {
            if (isForcingCheck) return;
            isForcingCheck = true;
            const loader = document.getElementById('trade-loading');
            loader.classList.add('active');
            try {
                await window.electronAPI.tradeForceCheck();
            } catch (e) {
                console.error(e);
            } finally {
                setTimeout(() => {
                    loader.classList.remove('active');
                    isForcingCheck = false;
                }, 300);
            }
        }

        window.electronAPI.onTradePosts((posts) => {
            const list = document.getElementById('post-list');
            list.innerHTML = '';
            if (!posts || posts.length === 0) {
                list.innerHTML = '<div class="text-[10px] text-slate-700 text-center py-10 font-bold uppercase tracking-widest opacity-50">게시글이 없습니다.</div>';
                return;
            }

            posts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'post-item group border border-white/5 bg-black/20';

                let dateHtml = `<div class="text-[10px] text-slate-500 w-12 text-right">${p.date}</div>`;

                div.innerHTML = `
            <div class="flex-1 overflow-hidden">
                <div class="truncate text-xs text-emerald-400 group-hover:text-emerald-300 transition-colors font-bold mb-1">${p.title}</div>
                <div class="flex items-center gap-2">
                    <div class="text-[10px] text-slate-500 font-medium">${p.writer}</div>
                    <div class="text-[9px] text-slate-700">#${p.no}</div>
                </div>
            </div>
            ${dateHtml}
        `;
                div.onclick = () => window.electronAPI.tradeOpenPost(p.url);
                list.appendChild(div);
            });
            refreshIcons();

            if (isForcingCheck) {
                document.getElementById('trade-loading').classList.remove('active');
                isForcingCheck = false;
            }
        });

        window.electronAPI.onConfigData((config) => {
            const badge = document.getElementById('keyword-badge');
            const guide = document.getElementById('keyword-guide');
            const guideTextContainer = document.getElementById('guide-text-container');
            const guideIcon = document.getElementById('guide-icon');
            const guideTitle = document.getElementById('guide-title');
            const guideSubtext = document.getElementById('guide-subtext');
            const guideBtn = document.getElementById('guide-btn');

            if (badge) {
                const kwCount = config.tradeKeywords?.length || 0;
                if (kwCount > 0) {
                    badge.innerText = `키워드 ${kwCount}`;
                    badge.className = 'text-[9px] bg-emerald-600 text-white px-1.5 py-0.5 rounded-full font-black border border-emerald-400 shadow-[0_0_8px_rgba(16,185,129,0.4)]';
                    if (guide) {
                        guide.className = 'shrink-0 p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-xl flex items-center justify-between transition-all';
                        guideTextContainer.className = 'flex items-center gap-2 text-emerald-400';
                        guideIcon.setAttribute('data-lucide', 'info');
                        guideTitle.innerText = `${kwCount}개의 키워드를 감시 중입니다`;
                        guideSubtext.innerText = config.tradeKeywords.join(', ');
                        guideBtn.className = 'shrink-0 ml-2 text-[9px] bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-300 px-3 py-1.5 rounded-lg font-bold transition-colors';
                        guideBtn.innerText = '설정 변경';
                    }
                } else {
                    badge.innerText = '키워드 미등록';
                    badge.className = 'text-[9px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded-full font-black border border-red-500/30';
                    if (guide) {
                        guide.className = 'shrink-0 p-3 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center justify-between transition-all';
                        guideTextContainer.className = 'flex items-center gap-2 text-red-400';
                        guideIcon.setAttribute('data-lucide', 'alert-circle');
                        guideTitle.innerText = '키워드를 등록해야 모니터링이 시작됩니다';
                        guideSubtext.innerText = '';
                        guideBtn.className = 'shrink-0 ml-2 text-[9px] bg-red-500/20 hover:bg-red-500/30 text-red-300 px-3 py-1.5 rounded-lg font-bold transition-colors';
                        guideBtn.innerText = '설정 열기';
                    }
                }
                refreshIcons();
            }

            const serverBadge = document.getElementById('server-badge');
            if (serverBadge) {
                if (config.tradeServer === 'RyXp') {
                    serverBadge.innerText = '하이아칸';
                    serverBadge.className = 'text-[9px] text-blue-400 font-bold tracking-wider px-1 bg-blue-500/10 rounded';
                } else if (config.tradeServer === 'Siwv') {
                    serverBadge.innerText = '네냐플';
                    serverBadge.className = 'text-[9px] text-orange-400 font-bold tracking-wider px-1 bg-orange-500/10 rounded';
                } else {
                    serverBadge.innerText = config.tradeServer || '서버 확인중';
                    serverBadge.className = 'text-[9px] text-slate-400 font-bold tracking-wider px-1';
                }
            }
        });

        window.electronAPI.onTradeConnectionStatus((isConnected) => {
            const statusLabel = document.getElementById('conn-status');
            if (isConnected) {
                statusLabel.innerText = 'Connected';
                statusLabel.className = 'text-[9px] text-slate-500 font-bold uppercase tracking-wider';
            } else {
                statusLabel.innerText = 'Disconnected';
                statusLabel.className = 'text-[9px] text-red-500 font-black uppercase tracking-wider animate-pulse';
            }
        });

        window.onload = async () => {
            refreshTrade();
        };

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') window.close();
        });

        refreshIcons();
    </script>
</body>

</html>